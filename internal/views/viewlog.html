<!DOCTYPE html>
<html>

<head>
    <title>Logs Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>

<body class="bg-gray-100 p-4" x-data="{
    traces: [],
    spans: [],
    logs: [],
    loading: false,
    searchQuery: '',
    isRealtime: false,
    realtimeInterval: null,
    open: false,
    fp: null,

    async fetchTraces(start, end) {
        this.loading = true;
        try {
            let url = `/jaeger/api/traces?service=todo-service`;
            if (start && end) {
                url += `&start=${start}&end=${end}`;
            }
            const response = await fetch(url);
            const data = await response.json();
            this.traces = data.data || [];
            this.spans = (data.data || []).map(trace => trace.spans).flat();
            const mappedLogs = (data.data || []).map(trace => {
                const logs = trace.spans.map(span => {
                    return span.logs.map(_log => {
                        const separateWord = _log.fields[0].value.split('#')
                        return {
                            timestamp: _log.timestamp,
                            operationName: span.operationName,
                            level: separateWord[0],
                            data: separateWord[1],
                        }
                    })
                })
                const flattenedLogs = logs.flat();
                return flattenedLogs
            }).flat();
            const sortedLogs = mappedLogs.sort((a, b) => b.timestamp - a.timestamp);
            this.logs = sortedLogs;
        } catch (error) {
            console.error('Error:', error);
        }
        this.loading = false;
    },

    toggleRealtime() {
        this.isRealtime = !this.isRealtime;
        if (this.isRealtime) {
            this.realtimeInterval = setInterval(() => this.fetchTraces(), 5000);
        } else {
            clearInterval(this.realtimeInterval);
        }
    },

    formatTime(timestamp) {
        const date = new Date(timestamp / 1000);
        return new Intl.RelativeTimeFormat('en', { numeric: 'auto' }).format(
            -Math.round((Date.now() - date) / 1000 / 60), 'minute'
        );
    },

    formatTime2(timestamp) {
        const date = new Date(timestamp / 1000);
        return date.toISOString().slice(0, 19).replace('T', ' ');
    },

    getStatusColor(tags) {
        const errorTag = tags.find(t => t.key === 'error');
        return errorTag ? 'text-red-600' : 'text-green-600';
    },

    setTimeRange(value) {
        const now = new Date();
        let start = new Date();
        
        switch(value) {
            case '30m': start.setMinutes(start.getMinutes() - 30); break;
            case '1h': start.setHours(start.getHours() - 1); break;
            case '2h': start.setHours(start.getHours() - 2); break;
            case '6h': start.setHours(start.getHours() - 6); break;
            case '12h': start.setHours(start.getHours() - 12); break;
            case '1d': start.setDate(start.getDate() - 1); break;
        }
        
        this.fp.setDate([start, now]);
        this.fetchTraces(start.getTime() * 1000, now.getTime() * 1000);
        this.open = false;
    },

    init() {
        this.fp = flatpickr('#start', {
            inline: true,
            mode: 'range',
            dateFormat: 'Y-m-d H:i',
            enableTime: true,
            time_24hr: true,
            defaultHour: new Date().getHours(),
            defaultMinute: new Date().getMinutes(),
            maxDate: 'today',
            minDate: '2024-01-01',
            onChange: (selectedDates) => {
                if (selectedDates.length === 2) {
                    this.fetchTraces(selectedDates[0].getTime() * 1000, selectedDates[1].getTime() * 1000);
                    this.open = false;
                }
            }
        });
        this.fetchTraces();
    },

    filteredLogs() {
        if (!this.searchQuery) return this.logs;
        const query = this.searchQuery.toLowerCase();
        return this.logs.filter(log => 
            log.operationName.toLowerCase().includes(query) ||
            log.level.toLowerCase().includes(query) ||
            log.data.toLowerCase().includes(query)
        );
    }
}" x-init="init()">
    <!-- Header -->
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-3xl font-bold">Logs Dashboard</h1>
        <div class="flex items-center space-x-4">
            <!-- Realtime Toggle -->
            <button class="flex items-center px-4 py-2 rounded-lg border"
                :class="isRealtime ? 'bg-green-500 text-white border-green-600' : 'bg-white text-gray-700 border-gray-300'"
                @click="toggleRealtime()">
                <svg class="w-4 h-4 mr-2" :class="isRealtime ? 'text-white' : 'text-gray-500'" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                <span x-text="isRealtime ? 'Realtime: ON' : 'Realtime: OFF'"></span>
            </button>

            <!-- Refresh Button -->
            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded flex items-center"
                x-on:click="fetchTraces()" x-bind:disabled="loading">
                <span x-show="loading">Loading...</span>
                <span class="flex items-center" x-show="!loading">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Refresh
                </span>
            </button>
        </div>
    </div>

    <!-- Loading indicator -->
    <div x-show="loading" class="text-center py-4">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
    </div>

    <!-- Error message -->
    <div x-show="spans.length === 0" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4">
        No spans found
    </div>
    <div class="grid grid-cols-6 gap-4">
        <!-- Quick Selector Dropdown -->
        <div class="relative mb-4 col-span-2" x-data="{ open: false }">
            <button @click="open = !open" class="flex items-center space-x-2 px-4 py-2 border rounded-lg bg-white">
                <span>Quick Selector</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </button>

            <!-- Dropdown Panel -->
            <div x-show="open" @click.away="open = false"
                class="absolute z-50 mt-4 w-auto bg-white rounded-lg shadow-lg border p-4  ">
                <!-- Quick Options -->
                <div class="grid grid-cols-4 gap-4">
                    <!-- shorttime -->
                    <div class="flex flex-col space-y-2 col-span-1">
                        <button class="bg-blue-500 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded text-sm"
                            @click="setTimeRange('30m')">30m
                        </button>
                        <button @click="setTimeRange('1h')"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded text-sm">1h
                        </button>
                        <button @click="setTimeRange('2h')"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded text-sm">2h
                        </button>
                        <button @click="setTimeRange('6h')"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded text-sm">6h
                        </button>
                        <button @click="setTimeRange('12h')"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded text-sm">12h
                        </button>
                        <button @click="setTimeRange('1d')"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded text-sm">1d
                        </button>
                    </div>
                    <!-- date -->
                    <div class="col-span-3">
                        <label for="start" class="block text-sm font-medium text-gray-700 ">Start date:</label>
                        <input type="text" id="start"
                            class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Search input -->
        <div class="col-span-4">
            <input type="text" x-model="searchQuery" placeholder="Search logs..."
                class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
    </div>
    <div id="logs" class="space-y-1">
        <template x-for="log in filteredLogs()" :key="log.timestamp">
            <div class="bg-white shadow border border-black-500 p-1 font-mono text-xs" x-data="{ expanded: false }">
                <!-- Normal view -->
                <div class="flex items-center space-x-2 cursor-pointer " x-show="!expanded" @click="expanded = true">
                    <span class="text-gray-500 whitespace-nowrap shrink-0" x-text="formatTime2(log.timestamp)"></span>
                    <span class="shrink-0" x-text="log.operationName"></span>
                    <span class="shrink-0" x-text="log.level"></span>
                    <span class="truncate flex-1" x-text="log.data"></span>
                </div>
                <!-- Expanded view -->
                <div x-show="expanded" class="cursor-pointer" @click="expanded = false">
                    <div class="flex gap-4">
                        <div class="">
                            <span class="text-gray-500 whitespace-nowrap shrink-0"
                                x-text="formatTime2(log.timestamp)"></span>
                            <span class="shrink-0" x-text="log.operationName"></span>
                            <span class="shrink-0" x-text="log.level"></span>
                        </div>
                        <pre x-text="JSON.stringify(JSON.parse(log.data), null, 4)" class="col-span-2 "></pre>
                    </div>
                </div>
            </div>
        </template>
    </div>
</body>

</html>